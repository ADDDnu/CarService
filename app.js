// ===================== Car Service WebApp ‚Äî app.js (FIXED) =====================
// - Single definitive implementations (no duplicate functions)
// - Save works reliably (setCars called)
// - Vehicle type supported
// - Home & Cars pages render groups by type
// - Import/Export + Local backup + Paste-import + Restore
// - MQTT actions (if mqtt.js loaded): testPublish()

// ===== Bottom Tab Bar =====
function renderTabbar(activeKey) {
  const tabbar = document.getElementById('tabbar');
  if (!tabbar) return;
  const isActive = k => (k === activeKey ? 'active' : '');
  tabbar.innerHTML = `
    <nav class="tabbar">
      <a href="index.html"    class="${isActive('home')}">
        <span class="icon">üè†</span><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </a>
      <a href="cars.html"     class="${isActive('cars')}">
        <span class="icon">üöó</span><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</span>
      </a>
      <a href="add.html"      class="${isActive('log')}">
        <span class="icon">üìù</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </a>
      <a href="settings.html" class="${isActive('settings')}">
        <span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </a>
    </nav>
  `;
  document.body.classList.add('has-tabbar');
}

// ===== Data Helpers =====
function getCars(){ return JSON.parse(localStorage.getItem("cars") || "[]"); }
function setCars(cars){
  localStorage.setItem("cars", JSON.stringify(cars));
  // local backup to help recovery
  localStorage.setItem("cars_backup", JSON.stringify(cars));
}

// ===== Import / Export (File) =====
function exportData(){
  const cars = getCars();
  const blob = new Blob([JSON.stringify(cars, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'car_data_backup.json'; a.click();
  URL.revokeObjectURL(url);
}

function importDataFromFile(ev){
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const cars = JSON.parse(e.target.result);
      setCars(cars);
      alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      location.reload();
    }catch(err){
      alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
  };
  reader.readAsText(file);
}

// ===== Paste Import / Restore Backup =====
function restoreFromBackup(){
  const txt = localStorage.getItem('cars_backup');
  if (!txt){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå'); return; }
  try{
    const data = JSON.parse(txt);
    if (!Array.isArray(data) || !data.length) throw new Error('empty');
    setCars(data);
    alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å backup ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    location.reload();
  }catch(e){
    alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function importFromTextarea(){
  const ta = document.getElementById('paste_json');
  if (!ta || !ta.value.trim()){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
  try{
    const data = JSON.parse(ta.value.trim());
    setCars(data);
    alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    location.reload();
  }catch(e){
    alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
}

// ===== Utilities =====
function vehicleTypeLabel(t){
  switch(t){
    case 'car': return '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå';
    case 'motorcycle': return '‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå';
    case 'agri': return '‡∏£‡∏ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£';
    default: return '‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå';
  }
}

// ===== Dashboard / Home =====
function renderHome(){
  if (typeof mqttConnect === 'function') try{ mqttConnect(); }catch(e){}
  renderTabbar('home');
  const all = getCars();
  // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  const map = new Map();
  for (let i = all.length - 1; i >= 0; i--) {
    const it = all[i];
    if (!map.has(it.plate)) map.set(it.plate, it);
  }
  const cars = Array.from(map.values());
  const total = cars.length;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô
  try {
    const hasNoData = !cars.length;
    const backup = localStorage.getItem('cars_backup');
    if (hasNoData && backup) {
      const data = JSON.parse(backup);
      if (Array.isArray(data) && data.length) {
        if (confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
          setCars(data);
          alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
          return renderHome();
        }
      }
    }
  } catch(e){}

  // Group by type
  const groups = { car: [], motorcycle: [], agri: [] };
  cars.forEach(c => { groups[(c.type||'car')]?.push(c); });

  const cardHTML = (c)=>{
    const mm = [c.make, c.model].filter(Boolean).join(' ');
    const tax = c.taxDueDate || '‚Äî';
    return `
      <div class="stat-card">
        <div>
          <div style="font-size:18px;font-weight:800;">${c.plate}</div>
          <div style="font-size:13px;color:#666;">${mm || '‚Äî'}</div>
          <div style="font-size:12px;color:#666;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${vehicleTypeLabel(c.type)}</div>
          <div style="font-size:13px;color:#666;">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏†‡∏≤‡∏©‡∏µ: ${tax}</div>
        </div>
        <div style="display:flex;gap:8px;align-self:center;">
          <a class="badge" href="history.html" onclick="localStorage.setItem('historyPlate','${c.plate}')">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
          <a class="badge" href="add.html" onclick="localStorage.setItem('editIndex','${all.findIndex(r => r.plate===c.plate)}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
        </div>
      </div>
    `;
  };

  const section = (title, arr)=> arr.length ? `<h2 class="section-title">${title}</h2>` + arr.map(cardHTML).join('') : '';

  const home = document.getElementById('home');
  home.innerHTML = `
    <div class="stat-card">
      <div>
        <div style="font-size:14px;color:#666;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
        <div style="font-size:28px;font-weight:800;">${total}</div>
      </div>
      <a href="cars.html" class="badge">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ ‚ûú</a>
    </div>
    ${section('‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', groups.car)}
    ${section('‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', groups.motorcycle)}
    ${section('‡∏£‡∏ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£', groups.agri)}
    ${(!groups.car.length && !groups.motorcycle.length && !groups.agri.length) ? '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ ‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Äù ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å</p>' : ''}
  `;
}

// ===== Cars List Page =====
function renderCars(){
  renderTabbar('cars');
  const listDiv = document.getElementById('cars-list');
  const items = getCars();

  if (!items.length){
    listDiv.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ ‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Äù ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å</p>';
    return;
  }

  // Group by type
  const groups = { car: [], motorcycle: [], agri: [] };
  items.forEach(car => { groups[(car.type||'car')]?.push(car); });

  const buildCards = (cars) => {
    return cars.map((car, index) => {
      const selected = [];
      if (car.maintenance?.engineOil) selected.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
      if (car.maintenance?.oilFilter)  selected.push("‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
      if (car.maintenance?.airFilter)  selected.push("‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®");
      const summary = selected.length ? selected.join(", ") : "‚Äî";
      const taxText = car.taxDueDate || "‚Äî";
      const mm = [car.make, car.model].filter(Boolean).join(' ');

      return `
        <div class="stat-card">
          <div>
            <div style="font-size:18px;font-weight:700;">${car.plate}</div>
            <div style="font-size:13px;color:#666;">${mm || '‚Äî'}</div>
            <div style="font-size:13px;color:#666;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${vehicleTypeLabel(car.type)}</div>
            <div style="font-size:13px;color:#666;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${car.serviceDate} (${car.odometerNow} ‡∏Å‡∏°.)</div>
            <div style="font-size:13px;color:#666;">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${car.nextServiceDate} (${car.nextOdometer} ‡∏Å‡∏°.)</div>
            <div style="font-size:13px;color:#666;">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏†‡∏≤‡∏©‡∏µ: ${taxText}</div>
            <div style="font-size:13px;color:#666;">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤: ${summary}</div>
          </div>
          <div style="display:flex;gap:8px;align-self:center;flex-wrap:wrap;">
            <a class="badge" href="add.html" onclick="localStorage.setItem('editIndex','${index}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            <button class="badge" type="button" onclick="testPublish(${index})">‡∏ó‡∏î‡∏™‡∏≠‡∏ö MQTT</button>
            <button class="badge" type="button" onclick="duplicateCar(${index})">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            <button class="badge" type="button" onclick="deleteCar(${index})" style="background:#c62828">‡∏•‡∏ö</button>
            <a class="badge" href="history.html" onclick="localStorage.setItem('historyPlate','${car.plate}')">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
          </div>
        </div>
      `;
    }).join('');
  };

  const section = (title, arr)=> arr.length ? `<h2 class="section-title">${title}</h2>` + buildCards(arr) : '';

  listDiv.innerHTML = `
    ${section('‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', groups.car)}
    ${section('‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', groups.motorcycle)}
    ${section('‡∏£‡∏ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£', groups.agri)}
  `;
}

// ===== Add/Edit Page =====
function saveCar(e){
  e.preventDefault();
  if (typeof mqttConnect === 'function') try{ mqttConnect(); }catch(e){}
  const cars = getCars();
  const idx  = localStorage.getItem("editIndex");

  const car  = {
    plate: document.getElementById("plate").value.trim(),
    make:  document.getElementById("make") ? document.getElementById("make").value.trim() : "",
    model: document.getElementById("model") ? document.getElementById("model").value.trim() : "",
    type:  document.getElementById("vehicleType") ? document.getElementById("vehicleType").value : "car",
    serviceDate: document.getElementById("serviceDate").value,
    odometerNow: parseInt(document.getElementById("odometerNow").value, 10),
    nextServiceDate: document.getElementById("nextServiceDate").value,
    nextOdometer: parseInt(document.getElementById("nextOdometer").value, 10),
    maintenance: {
      engineOil:   document.getElementById("m_engineOil").checked,
      gearOil:     document.getElementById("m_gearOil").checked,
      coolant:     document.getElementById("m_coolant").checked,
      flushingOil: document.getElementById("m_flushingOil").checked,
      oilFilter:   document.getElementById("m_oilFilter").checked,
      diffOil:     document.getElementById("m_diffOil").checked,
      airFilter:   document.getElementById("m_airFilter").checked,
      brakeFluid:  document.getElementById("m_brakeFluid").checked,
      wiper:       document.getElementById("m_wiper").checked,
      psFluid:     document.getElementById("m_psFluid").checked,
      notes:       document.getElementById("m_notes").value.trim()
    },
    taxDueDate: document.getElementById("taxDueDate").value
  };

  if (idx !== null && idx !== "null"){
    cars[parseInt(idx,10)] = car;
    localStorage.removeItem("editIndex");
  }else{
    cars.push(car);
  }
  setCars(cars);

  if (typeof mqttPublishCarNext === 'function') try{ mqttPublishCarNext(car); }catch(e){}

  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  window.location = "index.html";
}

function editCar(index){
  localStorage.setItem("editIndex", index);
  window.location = "add.html";
}

function initForm(){
  renderTabbar('log');
  if (typeof mqttConnect === 'function') try{ mqttConnect(); }catch(e){}
  const index = localStorage.getItem("editIndex");
  if (index !== null && index !== "null"){
    const cars = getCars();
    const car  = cars[parseInt(index,10)];
    if (!car) return;
    document.getElementById("plate").value = car.plate;
    if (document.getElementById("make"))  document.getElementById("make").value  = car.make  || "";
    if (document.getElementById("model")) document.getElementById("model").value = car.model || "";
    if (document.getElementById("vehicleType")) document.getElementById("vehicleType").value = car.type || "car";
    document.getElementById("serviceDate").value = car.serviceDate;
    document.getElementById("odometerNow").value = car.odometerNow;
    document.getElementById("nextServiceDate").value = car.nextServiceDate;
    document.getElementById("nextOdometer").value = car.nextOdometer;
    document.getElementById("taxDueDate").value = car.taxDueDate || "";

    if (car.maintenance){
      document.getElementById("m_engineOil").checked   = !!car.maintenance.engineOil;
      document.getElementById("m_gearOil").checked     = !!car.maintenance.gearOil;
      document.getElementById("m_coolant").checked     = !!car.maintenance.coolant;
      document.getElementById("m_flushingOil").checked = !!car.maintenance.flushingOil;
      document.getElementById("m_oilFilter").checked   = !!car.maintenance.oilFilter;
      document.getElementById("m_diffOil").checked     = !!car.maintenance.diffOil;
      document.getElementById("m_airFilter").checked   = !!car.maintenance.airFilter;
      document.getElementById("m_brakeFluid").checked  = !!car.maintenance.brakeFluid;
      document.getElementById("m_wiper").checked       = !!car.maintenance.wiper;
      document.getElementById("m_psFluid").checked     = !!car.maintenance.psFluid;
      document.getElementById("m_notes").value         = car.maintenance.notes || "";
    }
  }
}

// ===== History Page =====
function viewHistory(plate){
  localStorage.setItem("historyPlate", plate);
  window.location = "history.html";
}

function loadHistory(){
  renderTabbar('cars');
  const plate = localStorage.getItem("historyPlate");
  const cars = getCars();
  const filtered = cars.filter(c => c.plate === plate);

  const listDiv = document.getElementById("history-list");
  listDiv.innerHTML = `<h2>${plate||''}</h2>`;

  filtered.forEach(item => {
    const sel = [];
    const m = item.maintenance || {};
    if (m.engineOil)   sel.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
    if (m.gearOil)     sel.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå");
    if (m.coolant)     sel.push("‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏´‡∏°‡πâ‡∏≠‡∏ô‡πâ‡∏≥");
    if (m.flushingOil) sel.push("‡∏ü‡∏•‡∏±‡∏ä‡∏ã‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏¢‡∏•‡πå");
    if (m.oilFilter)   sel.push("‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á");
    if (m.diffOil)     sel.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á‡∏ó‡πâ‡∏≤‡∏¢");
    if (m.airFilter)   sel.push("‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®");
    if (m.brakeFluid)  sel.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ö‡∏£‡∏Å");
    if (m.wiper)       sel.push("‡πÉ‡∏ö‡∏õ‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏ù‡∏ô");
    if (m.psFluid)     sel.push("‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏û‡∏ß‡∏á‡∏°‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏û‡∏≤‡πÄ‡∏ß‡∏≠‡∏£‡πå");
    const listText = sel.length ? sel.join(", ") : "‚Äî";

    listDiv.innerHTML += `
      <div class="car-card">
        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£: ${item.serviceDate}</p>
        <p>‡πÄ‡∏•‡∏Ç‡∏Å‡∏°.: ${item.odometerNow}</p>
        <p>‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${item.nextServiceDate} (${item.nextOdometer} ‡∏Å‡∏°.)</p>
        <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤: ${listText}</p>
        ${m.notes ? `<p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${m.notes}</p>` : ""}
        <p>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏†‡∏≤‡∏©‡∏µ: ${item.taxDueDate||'‚Äî'}</p>
      </div>
    `;
  });
}

// ===== Settings Page =====
function renderSettings(){
  renderTabbar('settings');
  const cfg = JSON.parse(localStorage.getItem('cfg')||'{}');
  const url  = document.getElementById('cfg_mqtt_url');
  const user = document.getElementById('cfg_mqtt_user');
  const pass = document.getElementById('cfg_mqtt_pass');
  if (url){ url.value  = cfg.mqtt_url  || ''; }
  if (user){ user.value = cfg.mqtt_user || ''; }
  if (pass){ pass.value = cfg.mqtt_pass || ''; }
  const importInput = document.getElementById('import_file');
  if (importInput){ importInput.addEventListener('change', importDataFromFile); }
}

function saveSettings(e){
  e.preventDefault();
  const cfg = {
    mqtt_url : document.getElementById('cfg_mqtt_url').value.trim(),
    mqtt_user: document.getElementById('cfg_mqtt_user').value.trim(),
    mqtt_pass: document.getElementById('cfg_mqtt_pass').value
  };
  localStorage.setItem('cfg', JSON.stringify(cfg));
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
}

// ===== Actions on car items (Cars page) =====
function testPublish(index){
  try{ mqttConnect(); }catch(e){}
  const cars = getCars();
  const car = cars[index];
  if (!car){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ'); return; }
  try{
    mqttPublishCarNext(car);
    alert('‡∏™‡πà‡∏á MQTT ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
  }catch(err){
    console.error(err);
    alert('‡∏™‡πà‡∏á MQTT ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function deleteCar(index){
  const cars = getCars();
  const car = cars[index];
  if (!car){ return; }
  if (!confirm(`‡∏•‡∏ö‡∏£‡∏ñ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ${car.plate}?`)) return;
  cars.splice(index, 1);
  setCars(cars);
  renderCars();
}

function duplicateCar(index){
  const cars = getCars();
  const car = cars[index];
  if (!car){ return; }
  const newPlate = prompt('‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', `${car.plate}-copy`);
  if (!newPlate){ return; }
  const clone = JSON.parse(JSON.stringify(car));
  clone.plate = newPlate.trim();
  cars.push(clone);
  setCars(cars);
  alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  renderCars();
}
